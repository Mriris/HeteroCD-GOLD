超参数:
$\beta_{map}$, $\beta_{ch}$, $\beta_{sp}$ - 差异图、通道注意力和空间注意力损失的权重系数
$\varepsilon$ - 小常数(用于数值稳定性)

输入:
特征1, 特征2 - 两个时相的特征映射

输出:
差异图, 通道注意力图, 空间注意力图, 差异图注意力损失(用于蒸馏)

过程:
// 计算多度量差异图
// 欧氏距离差异
欧氏距离差异 = 平方根(求和((特征1 - 特征2)**2, dim=1, keepdim=True) + $\varepsilon$)

// 余弦距离差异 - 使用归一化计算余弦相似度
特征1_归一化 = L2归一化(特征1, dim=1)  // L2归一化
特征2_归一化 = L2归一化(特征2, dim=1)  // L2归一化
余弦相似度 = 求和(特征1_归一化 * 特征2_归一化, dim=1, keepdim=True)
余弦距离差异 = 1.0 - 余弦相似度

// 组合差异图并进行非线性变换
组合差异图 = (欧氏距离差异 + 余弦距离差异) / 2.0
差异图 = 双曲正切(组合差异图 * 2.0) * 0.5 + 0.5  // 非线性变换到0-1区间

// 生成空间注意力 - 使用一次性操作替代多次计算
空间特征 = 拼接([
    求平均值(特征, dim=1, keepdim=True),  // 通道维度平均池化
    求最大值(特征, dim=1, keepdim=True)  // 通道维度最大池化
], dim=1)  // [B, 2, H, W]

空间注意力 = sigmoid(空间特征.求和(dim=1, keepdim=True))  // [B, 1, H, W]

// 生成通道注意力 - 使用单次池化操作而非分别计算
通道_avg_pool = 自适应全局平均池化(特征, (1, 1))  // [B, C, 1, 1]
通道_max_pool = 求最大值(特征.展平(2), dim=2, keepdim=True)  // [B, C, 1]
通道_max_pool = 增加维度(通道_max_pool, -1)  // [B, C, 1, 1]

// 将池化结果组合计算sigmoid
通道注意力 = sigmoid((通道_avg_pool + 通道_max_pool) / 2.0)  // [B, C, 1, 1]

// 对于蒸馏损失计算示例 (教师网络和学生网络之间)
// 确保两个网络的特征大小相同
if (学生特征.shape[2:] != 教师特征.shape[2:]):
    学生特征 = 双线性插值(学生特征, size=教师特征.shape[2:])

// 计算教师网络的差异图 (光学-光学)
教师_差异图 = 计算差异图(光学时相1特征, 光学时相2特征)
教师_空间注意力, 教师_通道注意力 = 计算注意力(教师特征)

// 计算学生网络的差异图 (光学-SAR)
学生_差异图 = 计算差异图(光学时相1特征, SAR时相2特征)
学生_空间注意力, 学生_通道注意力 = 计算注意力(学生特征)

// 计算差异图注意力损失 - MSE损失
差异图损失 = 均方误差(学生_差异图, 教师_差异图)
空间注意力损失 = 均方误差(学生_空间注意力, 教师_空间注意力)
通道注意力损失 = 均方误差(学生_通道注意力, 教师_通道注意力)

// 组合差异图注意力损失 - 加权求和
差异图注意力损失 = $\beta_{map}$ * 差异图损失 + $\beta_{ch}$ * 通道注意力损失 + $\beta_{sp}$ * 空间注意力损失